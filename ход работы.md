# Источник - семинар https://monsterlessons.com/project/series/pishem-api-na-nodejs

#1. Установка node на ноутбук via nvm
curl -o- https://raw.githubusercontent.com/creationix/nvm/v0.33.0/install.sh | bash

nvm install 8.9.2
nvm install 10.9.2

Все пакеты лежат здесь, и можно посмотреть, какие пакеты каждая версия содержит, и удалить какую-нибудь версию вручную.
ls ~/.nvm/versions/node/                               //v10.04.0 v12.19.0
ls ~/.nvm/versions/node/v12.19.0/lib/node_modules      //npm  @vue

nvm list
nvm use 5.9

проверка, что активно
node -v
npm -v


#2. Установка EXPRESS
npm init     //создаем болванку package.json
npm i express --save


//server.js
var express = require('express');

var app = express();    //экземпляр сервера

var artists = [
{
id: 1,
name: 'Metallica'
},
{
id: 2,
name: 'Iron Maiden'
},
{
id: 3,
name: 'Deep Purple'
}
];

//роуты сервера
app.get('/', function (req, res) {
res.send('Hello API');            //это выведется в броузере при http://localhost:3012
});

app.get('/artists', function (req, res) {   //http://localhost:3012/artists
res.send(artists);
});

app.get('/artists/:id', function (req, res) {    //запрос КОНКРЕТНОГО артиста по ДИНАМИЧЕСКОМУ РОУТУ //http://localhost:3012/artists/2
  var artist = artists.find(function (artist) {
    return artist.id === Number(req.params.id);
  })
  console.log('req.params.id', req.params.id);
  console.log(artist);
  res.send(artist);
});


//входной порт сервера
app.listen(3012, function () {
console.log('API app started')     //это сработает при запуске сервера. Надпись появиться в консоле
})

//запуск сервера -  node server.js,
//обращение к серверу из броузера -  http://localhost:3012, в броузере увидим 'Hello API'.




# JSON Viewer - что бы JSON-файл отображался в броузере красиво можно установить в броузер плагин "JSON Viewer".



#3. POST-запросы.

Что бы парсить рело запроса ставим на сервере
npm install body-parser --save

//server.js
var bodyParser = require('body-parser');

app.use(bodyParser.json());
app.use(bodyParser.urlencoded({ extended: true }));

app.post('/artists', function (req, res) {
  var artist = {
    id: Date.now(),
    name: req.body.name
   }
  artists.push(artist);
  res.send(artist);
})


# Postman - что бы не писать фронтенд, который бы отправлял бы нам POST-запросы будем использовать Postman.
https://identity.getpostman.com/signup?continue=https%3A%2F%2Fgo.postman.co%2Fbuild
вэб-версия, не работает -https://web.postman.co/workspace/ea26f38d-0be3-44c2-8faa-802a0e9bb9d2/request/create?requestId=2820876a-37b9-4fbf-ba75-a9b059ae0cad
Как пользоваться - https://losst.ru/kak-polzovatsya-postman

Установка Postman'a:
$ sudo apt update
$ sudo apt install snapd
$ sudo snap install postman

Далее запускаю через иконку, которая появиться среди всех прогремм Убунты,
захожу в свой аккаунт через Google
https://identity.getpostman.com/signup?continue=https%3A%2F%2Fgo.postman.co%2Fbuild

В нем мы указываем наш адрес http://localhost:3012/artists
тип запроса - POST
В закладке body включаем раздел row  и тип вводимого - JSON.
Для тела запроса прописываем
{"name": "Kola"}

Перезапускаем сервер,
в окне postman жмем Send
и в postman в окошечке чуть ниже увидим пришедший с сервера ответ
{
  "id": 1609582962553,
  "name": "Kola"
}

На то, что в коде слово "post" не определяется типо - не обращаем снимание. )) Работает и так.



# PUT-запросы.
У конкретного артиста меняем значение его поля "name" на значение "Ola".

app.put('/artists/:id', function (req, res) {
  var artist = artists.find(function (artist) {
    return artist.id === Number(req.params.id)
  });
  artist.name = req.body.name;   //копирование var artist прошло ССЫЛКОЙ(!), поэтому при изменении поля name у var artist измениться и абъект в массиве artists(!).
  res.sendStatus(200);           //обратно на фронт придет "OK", указывая, что запрос прошел успешно.
})

А запрос шлем PUT
на URL http://localhost:3012/artists/2
с телом
{"name": "Ola"}

В ответе получаем "OK".



# DEL-запрос.
Аналогично.
Тело запроса не формируем.
Кого удаляем - прописываем в URL


app.delete('/artists/:id', function (req, res) {
  artists = artists.filter(function (artist) {
    return artist.id !== Number(req.params.id)
  })
  res.sendStatus(200);
})


#4. mongodb
1) Устанавливаем MongoDB на ноутбук, глобально.
https://docs.mongodb.com/guides/server/install/
MongoDB имеет 2 разновидности: Community and Enterprise(предприятие).

Для личного пользования на Убунте установка описана здесь:
https://docs.mongodb.com/manual/tutorial/install-mongodb-on-ubuntu/

Далее запускаем mongodb-сервер. Пока он запущен, датабаза - существует. Остановить mongodb-сервер - Ctrl+C. ))
Поэтому express и mongodb мы должны запускать параллельно в разных вкладках консоли.

>mongod
или по туториалу:
>sudo systemctl start mongod


Дополнительные команды по запуску датабазы:
> sudo systemctl status mongod       //работает ли
> sudo systemctl stop mongod
> sudo systemctl restart mongod



2) Устанавливаем В ПРОЕКТ спец драйвер - mongodb.
>npm install mongodb --save

И далее его импортируем в server.js
//server.js
var MongoClient = require('mongodb').MongoClient;
var db;

MongoClient.connect('mongodb://localhost:27017/myapi', function (err, database) {
  if (err) {
    return console.log(err);
  }
  db = database;
  app.listen(3012, function () {  //помещаем сюда, что бы сервер стартовал только после формирования соединения с базой данных.
    console.log('API app started');
  })
})

//localhost:27017 - всегда стандартный.
//myapi - наше название базы данных


3) Запускаем
>sudo systemctl start mongod
>node server.js


В консоле появляется "API app started", т.е. все стартануло успешно, ошибка не проскочила.



# Добавляем нового artist в базу данных.
1) Редактируем 
app.post('/artists', function (req, res) {}) 
to

app.post('/artists', function (req, res) {
  var artist = {
    name: req.body.name
  };

  db.collection('artists').insert(artist, (err, result) => {
    if (err) {
      console.log(err);
      return res.sendStatus(500);
    }
    res.send(artist);  //Возврат сохраняемого артиста- НУЖЕН, т.к. в bd ему присуждается _id, который нам на фронте понадобиться.
  })
})

//db.collection('artists') - обращение к коллекции artists'. Если ее не существует, то она создается автоматически.

# ===>> db.collection('artists') - не срабатывает. ))


2) Шлем запрос via postman.
Метод - post,
URL - http://localhost:3012/artists
body - {"name": "Gosha"}
   
В возврате будет посылаемый нами артист +(!) с полем _id, которое ему будет присуждени в базе данных.


# ##########################################
## http://mongodb.github.io/node-mongodb-native/3.4/quick-start/quick-start/

# collection.functions
http://mongodb.github.io/node-mongodb-native/3.4/tutorials/collations/



Выборка с сортировкой по полю(по возрастанию - 1, по убыванию - -1):
db.peoples.find().sort({name: 1})     //use sort только после find() (!).


















